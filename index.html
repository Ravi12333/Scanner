<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>iPhone Barcode Scanner</title>

<script src="https://unpkg.com/@zxing/library@latest"></script>

<style>
body {
    font-family: Arial, sans-serif;
    text-align: center;
    padding: 10px;
}
video {
    width: 100%;
    border: 2px solid black;
    border-radius: 8px;
}
button {
    margin-top: 10px;
    padding: 10px 15px;
    font-size: 16px;
}
table {
    width: 100%;
    margin-top: 15px;
    border-collapse: collapse;
}
th, td {
    border: 1px solid black;
    padding: 6px;
}
th {
    background: #eee;
}
input {
    width: 100%;
    box-sizing: border-box;
}
</style>
</head>

<body>

<h3>Barcode Scanner</h3>

<video id="video" autoplay playsinline></video>

<br>
<button onclick="addNoCode()">No Code</button>

<table>
<thead>
<tr>
<th>#</th>
<th>Barcode</th>
<th>Format</th>
<th>Notes</th>
</tr>
</thead>
<tbody id="table"></tbody>
</table>

<!-- Beep sound (iPhone safe) -->
<audio id="beep" preload="auto">
  <source src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQAAAAA=" type="audio/wav">
</audio>

<script>
const codeReader = new ZXing.BrowserMultiFormatReader();
const video = document.getElementById("video");
const table = document.getElementById("table");
const beep = document.getElementById("beep");

let count = 0;
let scanned = new Set();
let audioUnlocked = false;

/* Unlock audio for iPhone */
function unlockAudio() {
  if (!audioUnlocked) {
    beep.play().then(() => {
      beep.pause();
      beep.currentTime = 0;
      audioUnlocked = true;
    }).catch(() => {});
  }
}

/* Unlock on first touch */
document.body.addEventListener("touchstart", unlockAudio, { once: true });

function addRow(barcode, format) {
    count++;
    table.innerHTML += `
      <tr>
        <td>${count}</td>
        <td>${barcode}</td>
        <td>${format}</td>
        <td><input type="text" placeholder="Add notes"></td>
      </tr>`;
}

function addNoCode() {
    unlockAudio();
    addRow("NO CODE", "-");
}

codeReader
  .listVideoInputDevices()
  .then(devices => {
    const cameraId = devices[0].deviceId;
    codeReader.decodeFromVideoDevice(cameraId, video, (result, err) => {
      if (result) {
        if (!scanned.has(result.text)) {
          scanned.add(result.text);
          if (audioUnlocked) beep.play();
          addRow(result.text, result.getBarcodeFormat());
        }
      }
    });
  })
  .catch(err => alert(err));
</script>

</body>
</html>
