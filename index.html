<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>iPhone Barcode Scanner</title>

<script src="https://unpkg.com/@zxing/library@latest"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

<style>
body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    text-align: center;
    padding: 20px;
    background-color: #f5f5f5;
    margin: 0;
}
h3 {
    margin-bottom: 20px;
    color: #333;
}
video {
    width: 100%;
    max-width: 400px;
    border: 2px solid #ccc;
    border-radius: 12px;
    background-color: #000;
}
.button-container {
    display: flex;
    justify-content: space-around;
    margin-top: 15px;
}
button {
    padding: 12px 24px;
    font-size: 16px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.3s;
}
#no-code-btn {
    background-color: #ff9500;
    color: white;
}
#export-pdf-btn {
    background-color: #007aff;
    color: white;
}
button:hover {
    opacity: 0.9;
}
table {
    width: 100%;
    max-width: 600px;
    margin: 20px auto 0;
    border-collapse: collapse;
    background-color: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
th, td {
    border: 1px solid #ddd;
    padding: 10px;
    text-align: left;
}
th {
    background: #f0f0f0;
    color: #333;
}
input {
    width: 100%;
    box-sizing: border-box;
    border: none;
    background: transparent;
    font-size: 14px;
}
</style>
</head>

<body>

<h3>Barcode Scanner</h3>

<video id="video" autoplay playsinline></video>

<div class="button-container">
    <button id="no-code-btn" onclick="addNoCode()">No Code</button>
    <button id="export-pdf-btn" onclick="exportToPDF()">Export to PDF</button>
</div>

<table>
<thead>
<tr>
<th>#</th>
<th>Barcode</th>
<th>Format</th>
<th>Notes</th>
</tr>
</thead>
<tbody id="table"></tbody>
</table>

<!-- Beep sound (iPhone safe) -->
<audio id="beep" preload="auto">
  <source src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQAAAAA=" type="audio/wav">
</audio>

<script>
const codeReader = new ZXing.BrowserMultiFormatReader();
const video = document.getElementById("video");
const tableBody = document.getElementById("table");
const beep = document.getElementById("beep");

let count = 0;
let scanned = new Set();
let audioUnlocked = false;

/* Unlock audio for iPhone */
function unlockAudio() {
  if (!audioUnlocked) {
    beep.play().then(() => {
      beep.pause();
      beep.currentTime = 0;
      audioUnlocked = true;
    }).catch(() => {});
  }
}

/* Unlock on first touch */
document.body.addEventListener("touchstart", unlockAudio, { once: true });

function addRow(barcode, format) {
    count++;
    const row = document.createElement('tr');
    row.innerHTML = `
        <td>${count}</td>
        <td>${barcode}</td>
        <td>${format}</td>
        <td><input type="text" placeholder="Add notes"></td>
    `;
    tableBody.appendChild(row);
}

function addNoCode() {
    unlockAudio();
    addRow("NO CODE", "-");
}

function exportToPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    const tableData = [];
    const rows = tableBody.querySelectorAll('tr');
    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        const rowData = [
            cells[0].textContent,
            cells[1].textContent,
            cells[2].textContent,
            cells[3].querySelector('input').value || ''
        ];
        tableData.push(rowData);
    });

    doc.autoTable({
        head: [['#', 'Barcode', 'Format', 'Notes']],
        body: tableData,
        theme: 'striped',
        margin: { top: 20 },
        styles: { fontSize: 10 }
    });

    doc.save('scanned_barcodes.pdf');
}

codeReader
  .listVideoInputDevices()
  .then(devices => {
    const cameraId = devices[devices.length - 1].deviceId; // Prefer back camera on iPhone
    codeReader.decodeFromVideoDevice(cameraId, video, (result, err) => {
      if (result) {
        if (!scanned.has(result.text)) {
          scanned.add(result.text);
          if (audioUnlocked) {
            beep.play();
          }
          addRow(result.text, ZXing.BarcodeFormat[result.format]);
        }
      }
    });
  })
  .catch(err => alert(err));
</script>

</body>
</html>
